//full code
#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>
#include <RTClib.h>
#include <OneWire.h>
#include <DallasTemperature.h>

#define TFT_MOSI 6
#define TFT_SCLK 4
#define TFT_RST  2
#define TFT_DC   0
#define TFT_CS  -1

#define DS3231_SDA 8
#define DS3231_SCL 10
#define ONE_WIRE_BUS 7
#define TOUCH_PIN 3

Adafruit_ST7789 tft = Adafruit_ST7789(&SPI, TFT_CS, TFT_DC, TFT_RST);
RTC_DS3231 rtc;
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensors(&oneWire);

// âœ… Paste cÃ¡c máº£ng RGB565 táº¡i Ä‘Ã¢y (áº£nh PNG 240x240 Ä‘Ã£ chuyá»ƒn báº±ng Image2CPP)
const uint16_t frame1[57600] PROGMEM = {     //áº£nh chÃ o  };
const uint16_t frame2[57600] PROGMEM = {     //áº£nh       };
const uint16_t frame3[57600] PROGMEM = {     //áº£nh       };
const uint16_t frame4[57600] PROGMEM = {     //áº£nh       };
const uint16_t frame5[57600] PROGMEM = {     //áº£nh       };
const uint16_t frame6[57600] PROGMEM = {     //áº£nh       };
const uint16_t frame7[57600] PROGMEM = {     //áº£nh       };
const uint16_t smileFace[57600] PROGMEM = {  //matcuoi   };

const uint16_t* frames[] = { frame1, frame2, frame3, frame4, frame5, frame6, frame7 };
const int totalFrames = 7;

int mode = 1;
int frameIndex = 0;
bool greetingShown = false;
bool smileShown = false;
bool forceRefresh = true;

bool lastTouchState = false;
unsigned long touchStartTime = 0;
const unsigned long holdThreshold = 1000;

float lastTemp = -999;
int lastMinute = -1;
int lastDay = -1;
String lastGreeting = "";

// âœ… HÃ m váº½ chá»¯ cÄƒn giá»¯a vá»›i ná»n tÃ¹y chá»n
void drawCenteredTextWithBackground(int y, int size, uint16_t textColor, uint16_t bgColor, String text) {
  tft.setTextSize(size);
  tft.setTextColor(textColor);
  tft.setTextWrap(false);
  int16_t x1, y1;
  uint16_t w, h;
  tft.getTextBounds(text, 0, 0, &x1, &y1, &w, &h);
  tft.fillRect(0, y, 240, h, bgColor);
  tft.setCursor((240 - w) / 2, y);
  tft.print(text);
}

void setup() {
  Serial.begin(115200);
  delay(500);

  pinMode(TOUCH_PIN, INPUT);
  SPI.begin(TFT_SCLK, -1, TFT_MOSI, TFT_CS);
  tft.init(240, 240, SPI_MODE3);
  tft.setRotation(1);
  tft.setSPISpeed(8000000);
  tft.fillScreen(ST77XX_BLACK);

  Wire.begin(DS3231_SDA, DS3231_SCL);
  rtc.begin();
  if (rtc.lostPower()) {
    rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
  }

  sensors.begin();

  // âœ… Hiá»ƒn thá»‹ frame1 khi khá»Ÿi Ä‘á»™ng
  tft.drawRGBBitmap(0, 0, frames[0], 240, 240);
  
}

void loop() {
  bool touchState = digitalRead(TOUCH_PIN);
  unsigned long nowMillis = millis();

  if (touchState && !lastTouchState) {
    touchStartTime = nowMillis;
  }

  if (!touchState && lastTouchState) {
    unsigned long pressDuration = nowMillis - touchStartTime;

    if (pressDuration >= holdThreshold) {
      // ðŸ‘‰ Nháº¥n giá»¯ â†’ chuyá»ƒn cháº¿ Ä‘á»™
      if (mode == 1) {
        mode = 2;
        smileShown = false;
    forceRefresh = true;           // Ã©p váº½ láº¡i toÃ n bá»™
    lastTemp = -999;               // reset nhiá»‡t Ä‘á»™
    lastMinute = -1;               // reset giá»
    lastDay = -1;                  // reset ngÃ y
    lastGreeting = "";             // reset lá»i chÃ o
        tft.fillScreen(ST77XX_BLACK);
      } else {
        mode = 1;
        frameIndex = 0;
        greetingShown = false;
        tft.fillScreen(ST77XX_BLACK);
        tft.drawRGBBitmap(0, 0, frames[0], 240, 240);
      }
    } else {
      // ðŸ‘‰ Cháº¡m ngáº¯n â†’ xá»­ lÃ½ theo tá»«ng cháº¿ Ä‘á»™
      if (mode == 1) {
        if (!greetingShown) {
          // âœ… Hiá»ƒn thá»‹ "tran cong thy" vá»›i ná»n xanh biá»ƒn
          uint16_t bgColor = ST77XX_BLUE;
          tft.fillScreen(bgColor);
          drawCenteredTextWithBackground(80, 3, ST77XX_MAGENTA, bgColor, "HAPY BIRTHDAY");
          drawCenteredTextWithBackground(140, 3, ST77XX_WHITE, bgColor, "Cam Phuong");
          greetingShown = true;
        } else {
          frameIndex++;
          if (frameIndex >= totalFrames) frameIndex = 1;
          tft.drawRGBBitmap(0, 0, frames[frameIndex], 240, 240);
        }
      } else if (mode == 2) {
        if (!smileShown) {
          tft.drawRGBBitmap(0, 0, smileFace, 240, 240);
          smileShown = true;
        }
      }
    }
  }

  lastTouchState = touchState;

  // âœ… Cháº¿ Ä‘á»™ 2: hiá»ƒn thá»‹ thÃ´ng sá»‘ náº¿u chÆ°a hiá»‡n máº·t cÆ°á»i
  if (mode == 2 && !smileShown) {
    DateTime now = rtc.now();
    sensors.requestTemperatures();
    float tempC = sensors.getTempCByIndex(0);

    int greetingY = 10;
    int tempY = 50;
    int dateY = 180;
    int timeY = ((tempY + dateY) / 2) - 10;

    int hour = now.hour();
    String greetingLine = "";
    if (hour >= 4 && hour <= 11) greetingLine = "chao buoi sang";
    else if (hour >= 12 && hour <= 18) greetingLine = "chao buoi chieu";
    else greetingLine = "chao buoi toi";

    if (greetingLine != lastGreeting) {
      drawCenteredTextWithBackground(greetingY, 2, ST77XX_CYAN, ST77XX_BLACK, greetingLine);
      lastGreeting = greetingLine;
    }

    if (abs(tempC - lastTemp) > 0.1) {
      lastTemp = tempC;
      String tempStr = (tempC == -127.0) ? "Err" : String(tempC, 1) + " C";
      uint16_t tempColor = ST77XX_WHITE;
      if (tempC > 31.0) tempColor = ST77XX_RED;
      else if (tempC < 23.0) tempColor = ST77XX_BLUE;
      drawCenteredTextWithBackground(tempY, 3, tempColor, ST77XX_BLACK, tempStr);
    }

    if (now.minute() != lastMinute) {
      lastMinute = now.minute();
      char timeStr[16];
      sprintf(timeStr, "%02d:%02d", now.hour(), now.minute());
      drawCenteredTextWithBackground(timeY, 6, ST77XX_GREEN, ST77XX_BLACK, String(timeStr));
    }

    if (now.day() != lastDay) {
      lastDay = now.day();
      char dateStr[20];
      sprintf(dateStr, "%02d/%02d/%04d", now.day(), now.month(), now.year());
      drawCenteredTextWithBackground(dateY, 3, ST77XX_CYAN, ST77XX_BLACK, String(dateStr));
    } 
    forceRefresh = false;
  }

  delay(100);
}